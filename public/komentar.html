<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>KOMENTAR BY YUDZXML</title>
    <link rel="stylesheet" href="style.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      .rating-input {
        display: flex;
        flex-direction: row-reverse;
        justify-content: flex-start;
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        margin-left: 3.7rem;
        margin-right: 15rem;
      }
      .rating-input input { display: none; }
      .rating-input label {
        cursor: pointer;
        color: #ccc;
        transition: color 0.2s;
      }
      .rating-input label:hover,
      .rating-input label:hover ~ label,
      .rating-input input:checked ~ label {
        color: gold;
      }

      .star-rating {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
      }
      .star-rating .star {
        font-size: 1.25rem;
        margin-right: 2px;
      }
      .star-rating span {
        font-size: 1.25rem;
        margin-right: 2px;
        color: gold;
        
      }
      .star-rating .empty {
        color: #ccc;
      }

      .card-testimoni {
        background: var(--card-bg, #fff);
        border-radius: 8px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        margin-bottom: 1rem;
        transition: transform 0.2s, box-shadow 0.2s;
      }
      .card-testimoni:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }
      .card-testimoni .content {
        font-family: 'Poppins', sans-serif;
        padding: 1rem;
      }
      .info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }
      .info-row h4 { margin: 0; }
      .info-row button {
        background: transparent;
        border: none;
        color: #e74c3c;
        cursor: pointer;
        font-size: 0.9rem;
      }
      .info-row button:hover { text-decoration: underline; }
    </style>
  </head>
  <body>
    <!-- SIDEBAR -->
    <aside id="sidebar">
  <button id="sidebarClose" class="sidebar-close">×</button>
  <div class="sidebar-section">
    <button onclick="location.href='login.html'" class="btn btn-primary sidebar-btn">
      <span class="icon">🔒</span> Admin Login
    </button>
    <button onclick="location.href='cart.html'" class="btn btn-primary sidebar-btn">
      <span class="icon">🛒</span> Cek Keranjang
    </button>
    <button onclick="location.href='testimoni.html'" class="btn btn-primary sidebar-btn">
      <span class="icon">⭐</span> Testimoni
    </button>
    <button onclick="location.href='promo.html'" class="btn btn-primary sidebar-btn">
      <span class="icon">🏷️</span> Diskon Produk
    </button>
    <button onclick="location.href='komentar.html'" class="btn btn-primary sidebar-btn">
      <span class="icon">💬</span> Komentar/Ratting
    </button>
    <button onclick="location.href='contact.html'" class="btn btn-primary sidebar-btn">
      <span class="icon">✉️</span> Contact Admin
    </button>   
    <button onclick="location.href='uploader.html'" class="btn btn-primary sidebar-btn">
     <span class="icon">📤</span> Upload File
    </button>
    <button onclick="location.href='visitor.html'" class="btn btn-primary sidebar-btn">
          <span class="icon">👥</span> Static Pengunjung
        </button>
    <button onclick="location.href='donasi.html'" class="btn btn-primary sidebar-btn active">
          <span class="icon">💖</span> Donasi
        </button>       
    <button onclick="location.href='service.html'" class="btn btn-primary sidebar-btn">
      <span class="icon">📜</span> Terms of Service
    </button>        
  </div>
</aside>

    <!-- HEADER -->
    <header class="site-header">
      <div class="container">
        <button id="sidebarToggle" class="sidebar-toggle">☰</button>
        <div class="header-left">
          <h1 class="logo">オ KOMENTAR PUBLIK</h1>
        </div>
        <div class="header-center">
          <input
            type="text"
            id="searchInput"
            placeholder="Cari produk..."
            autocomplete="off"
          />
        </div>
        <div class="header-right">
          <button
            id="darkModeToggle"
            class="dark-toggle"
            title="Toggle Dark Mode"
          >
            <div class="toggle-track">
              <span class="icon-sun">☀️</span>
              <span class="icon-moon">🌙</span>
            </div>
          </button>
          <button id="openCartBtn" class="icon-btn" title="Keranjang">🏠      
          </button>
        </div>
      </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="container" style="flex-direction: column; align-items: stretch; padding-top: 2rem;">
      <h2>Daftar Komentar</h2>
      <div id="commentsList" class="form-container" style="max-height: 400px; overflow-y: auto;">
        <p id="loadingText">Memuat komentar…</p>
      </div>

      <div class="form-container" style="margin-top: 2rem;">
        <h3>Tambah Komentar Anda</h3>
        <form id="commentForm">
          <div class="form-group">
            <label for="username">Nama Anda:</label>
            <input type="text" id="username" name="username" placeholder="Masukkan nama Anda" required />
          </div>

          <div class="form-group">
            <label>Rating:</label>
            <div class="rating-input">
              <input type="radio" id="star5" name="rating" value="5" required />
              <label for="star5" title="5 bintang">★</label>
              <input type="radio" id="star4" name="rating" value="4" />
              <label for="star4" title="4 bintang">★</label>
              <input type="radio" id="star3" name="rating" value="3" />
              <label for="star3" title="3 bintang">★</label>
              <input type="radio" id="star2" name="rating" value="2" />
              <label for="star2" title="2 bintang">★</label>
              <input type="radio" id="star1" name="rating" value="1" />
              <label for="star1" title="1 bintang">★</label>
            </div>
          </div>

          <div class="form-group">
            <label for="commentText">Komentar:</label>
            <textarea id="commentText" name="commentText" placeholder="Tulis komentar Anda di sini…" required></textarea>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary">Kirim Komentar</button>
          </div>
        </form>
      </div>
    </main>

    <!-- FOOTER -->
    <footer class="site-footer">
      <div class="container">
        <p>© 2025 YUDZXML Allright Reserved</p>
      </div>
    </footer>

    <script>
      const sidebar = document.getElementById("sidebar");
      const sidebarToggle = document.getElementById("sidebarToggle");
      const sidebarClose = document.getElementById("sidebarClose");
      const openCartBtn = document.getElementById("openCartBtn");
      sidebarToggle.addEventListener("click", () => sidebar.classList.add("open"));
      sidebarClose.addEventListener("click", () => sidebar.classList.remove("open"));
      document.getElementById("darkModeToggle").addEventListener("click", () => document.body.classList.toggle("dark-mode"));
      openCartBtn.addEventListener('click', () => window.location.href = 'index.html');

      // API endpoints
      const BASE_API_URL = "/api";
      const COMMENTS_ENDPOINT = `${BASE_API_URL}/comments`;

      function createCommentElement({ id, username, text, rating, created_at }) {
        const wrapper = document.createElement("div");
        wrapper.classList.add("card-testimoni");

        const content = document.createElement("div");
        content.classList.add("content");

        const infoRow = document.createElement("div");
        infoRow.classList.add("info-row");

        const nameEl = document.createElement("h4");
        nameEl.textContent = username;

        const dateEl = document.createElement("span");
        dateEl.textContent = new Date(created_at).toLocaleString("id-ID", { dateStyle: "medium", timeStyle: "short" });
        dateEl.style.fontStyle = "italic";
        dateEl.style.color = "#777";

        infoRow.append(nameEl, dateEl);

        const currentUser = localStorage.getItem('currentUser');
        if (currentUser === username) {
          const delBtn = document.createElement('button');
          delBtn.textContent = 'Hapus';
          delBtn.onclick = async () => {
            if (!confirm('Yakin hapus komentar ini?')) return;
            try {
              const res = await fetch(`${COMMENTS_ENDPOINT}/${id}`, { method: 'DELETE' });
              if (!res.ok) throw new Error(res.statusText);
              fetchComments();
            } catch (err) {
              alert('Error menghapus: ' + err.message);
            }
          };
          infoRow.appendChild(delBtn);
        }

        const ratingRow = document.createElement("div");
        ratingRow.classList.add("star-rating");
        for (let i = 1; i <= 5; i++) {
          const star = document.createElement('span');
          star.textContent = i <= rating ? '★' : '☆';
          if (i > rating) star.classList.add('empty');
          ratingRow.appendChild(star);
        }

        const textEl = document.createElement('p');
        textEl.textContent = text;

        content.append(infoRow, ratingRow, textEl);
        wrapper.appendChild(content);
        return wrapper;
      }

      // render comments
      async function fetchComments() {
        const listContainer = document.getElementById("commentsList");
        const loadingText = document.getElementById("loadingText");
        loadingText.textContent = "Memuat komentar…";
        try {
          const response = await fetch(COMMENTS_ENDPOINT);
          if (!response.ok) throw new Error(response.statusText);
          const comments = await response.json();
          comments.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
          listContainer.innerHTML = '';
          if (!comments.length) {
            listContainer.innerHTML = '<p>Belum ada komentar.</p>';
            return;
          }
          comments.forEach(c => listContainer.appendChild(createCommentElement(c)));
        } catch (err) {
          listContainer.innerHTML = `<p style="color:red;">${err.message}</p>`;
        }
      }

      async function postComment(event) {
        event.preventDefault();
        const usernameInput = document.getElementById("username");
        const commentInput = document.getElementById("commentText");
        const ratingInputs = document.getElementsByName("rating");
        const username = usernameInput.value.trim();
        const text = commentInput.value.trim();
        let rating = null;
        ratingInputs.forEach(r => { if (r.checked) rating = Number(r.value); });
        if (!username || !text || rating === null) {
          return alert('Nama, rating, dan komentar harus diisi.');
        }
        // Rate limit
        const now = Date.now();
        const last = localStorage.getItem(`lastCommentTime_${username}`);
        if (last && now - Number(last) < 60000) {
          const sec = Math.ceil((60000 - (now - Number(last))) / 1000);
          return alert(`Tunggu ${sec} detik sebelum komentar lagi.`);
        }
        try {
          const payload = { username, text, rating };
          const res = await fetch(COMMENTS_ENDPOINT, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          if (!res.ok) throw new Error(res.statusText);
          localStorage.setItem(`lastCommentTime_${username}`, now);
          localStorage.setItem('currentUser', username);
          usernameInput.value = '';
          commentInput.value = '';
          ratingInputs.forEach(r => r.checked = false);
          fetchComments();
        } catch (err) {
          alert('Gagal kirim: ' + err.message);
        }
      }

      document.addEventListener('DOMContentLoaded', () => {
        fetchComments();
        document.getElementById('commentForm').addEventListener('submit', postComment);
      });
    </script>
  </body>
</html>